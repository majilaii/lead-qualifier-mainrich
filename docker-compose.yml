# ============================================================
# ◈ Hunt — Docker Compose
#
# Usage:
#   docker compose up              # Start both services (dev mode, hot-reload)
#   docker compose up backend      # Backend only
#   docker compose up -d           # Detached mode
#   docker compose down            # Stop everything
#   docker compose up --build      # Force rebuild (after dep changes)
#
#   # Run the CLI pipeline instead of the API server:
#   docker compose run --rm backend python main.py --test
#   docker compose run --rm backend python main.py --input input_leads.csv
#   docker compose run --rm backend python test_exa.py --export
# ============================================================

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hunt-api
    ports:
      - "8000:8000"
    env_file:
      - ./backend/.env
    volumes:
      # ── Mount ALL source code so edits reflect instantly ──
      - ./backend:/app
      # Prevent host node artifacts from leaking in
      - /app/__pycache__
    # Override CMD → run with --reload so uvicorn picks up file changes
    command: ["uvicorn", "chat_server:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: deps            # Only use the deps stage (node_modules installed)
    container_name: hunt-web
    ports:
      - "3000:3000"
    environment:
      - CHAT_BACKEND_URL=http://backend:8000
      - NEXT_PUBLIC_BACKEND_URL=http://localhost:8000
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:-}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:-}
      - NEXT_PUBLIC_MAPBOX_TOKEN=${NEXT_PUBLIC_MAPBOX_TOKEN:-}
      - WATCHPACK_POLLING=true   # Ensures file-watching works inside Docker on macOS
    volumes:
      # ── Mount ALL source code so edits reflect instantly ──
      - ./frontend:/app
      # Keep container's node_modules (don't overwrite with host's)
      - /app/node_modules
      - /app/.next
    # Override CMD → run Next.js dev server instead of production standalone
    command: ["npx", "next", "dev", "--hostname", "0.0.0.0", "--port", "3000"]
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
